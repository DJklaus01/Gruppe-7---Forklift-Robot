<?xml version="1.0" ?>
<robot name="mobile_manipulator_robot" xmlns:xacro="http://ros.org/wiki/xacro">
    <xacro:include filename="$(find custom_robot_sim)/urdf/common_macros.xacro" />

    <!-- Arm-parametere -->
    <xacro:property name="L1" value="0.4"/>   <!-- skulder → albue (tidl. 0.385) -->
    <xacro:property name="L2" value="0.4"/>   <!-- albue → håndledd (tidl. 0.270) -->
    <xacro:property name="L3" value="0.115"/>   <!-- håndledd-lenke (tidl. 0.115) -->
    <xacro:property name="R"  value="0.0375"/>  <!-- cylinder-radius = 0.075/2 -->

  <!-- Gazebo ros2_control plugin (+ peker til YAML) -->
  <gazebo>
    <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
      <parameters>$(find custom_robot_sim)/config/controller_config.yaml</parameters>
    </plugin>
  </gazebo>

  <!-- ros2_control grensesnitt -->
  <ros2_control name="GazeboSystem" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>

    <!-- Bakhjul: styring (posisjon) -->
    <joint name="back_left_steer_joint">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="back_right_steer_joint">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <!-- Forhjul: drift (hastighet) -->
    <joint name="front_left_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="front_right_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <!-- ARM joints: position-kommando -->
    <joint name="link_1_joint">
        <command_interface name="position"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
    </joint>

    <joint name="link_2_joint">
        <command_interface name="position"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
    </joint>

    <joint name="link_3_joint">
        <command_interface name="position"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
    </joint>

    <joint name="ee_slider_joint">
        <command_interface name="position"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
    </joint>
  </ros2_control>

    <!-- <gazebo>
        <static>true</static>
    </gazebo> -->

    <xacro:property name="density_pla" value="600" />

    <!--############################### -->
    <!-- MOBILE PLATFORM -->
    <!--############################### -->

    <link name="base_footprint"/>

    <joint name="base_joint" type="fixed">
        <parent link="base_footprint"/>
        <child link="mobile_base_link" />
        <origin xyz="0 0 0.15" rpy="0 0 0"/>
    </joint>

    <!-- MOBILE BASE -->
    <!-- ==================================== -->

    <link name="mobile_base_link">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <mesh filename="$(find custom_robot_sim)/meshes/base_mesh.stl" />
                <!-- <box size="0.650 0.400 0.200"/> -->
            </geometry>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="0.650 0.400 0.200"/>
            </geometry>
        </collision>
        <xacro:inertial_box length="0.650" width="0.400" height="0.200" density="${density_pla}">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_box>
    </link>

<gazebo reference="mobile_base_link">
  <material>Gazebo/Grass</material>
</gazebo>

<!-- FRONT LEFT WHEEL (drift) -->
<joint type="continuous" name="front_left_wheel_joint">
  <origin xyz="0.200 0.255 -0.050" rpy="0 0 0"/>
  <parent link="mobile_base_link"/>
  <child link="front_left_wheel_link"/>
  <axis xyz="0 1 0"/>
  <limit effort="1000" velocity="1000"/>
  <dynamics damping="0.7" friction="1.0"/>
</joint>

<link name="front_left_wheel_link">
  <visual>
    <!-- Roter visual som collision (90° rundt X) -->
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><mesh filename="$(find custom_robot_sim)/meshes/wheel_mesh.stl"/></geometry>
  </visual>
  <collision>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><cylinder length="0.1" radius="0.1"/></geometry>
  </collision>
  <xacro:inertial_cylinder radius="0.1" length="0.1" density="${density_pla}">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:inertial_cylinder>
</link>

<gazebo reference="front_left_wheel_link">
  <material>Gazebo/Grey</material>
</gazebo>

<!-- FRONT RIGHT WHEEL (drift) -->
<joint type="continuous" name="front_right_wheel_joint">
  <origin xyz="0.200 -0.255 -0.050" rpy="0 0 0"/>
  <parent link="mobile_base_link"/>
  <child link="front_right_wheel_link"/>
  <axis xyz="0 1 0"/>
  <limit effort="1000" velocity="1000"/>
  <dynamics damping="0.7" friction="1.0"/>
</joint>

<link name="front_right_wheel_link">
  <visual>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><mesh filename="$(find custom_robot_sim)/meshes/wheel_mesh.stl"/></geometry>
    <material name="rubber_black"/>
  </visual>
  <collision>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><cylinder length="0.1" radius="0.1"/></geometry>
  </collision>
  <xacro:inertial_cylinder radius="0.1" length="0.1" density="${density_pla}">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:inertial_cylinder>
</link>

<gazebo reference="front_right_wheel_link">
  <material>Gazebo/Grey</material>
</gazebo>

<!-- BACK RIGHT: steer + passiv hjulrotasjon -->
<joint type="revolute" name="back_right_steer_joint">
  <origin xyz="-0.200 -0.255 -0.050" rpy="0 0 0"/>
  <parent link="mobile_base_link"/>
  <child link="back_right_steer_link"/>
  <axis xyz="0 0 1"/>
  <limit lower="-0.7854" upper="0.7854" effort="200" velocity="1.5"/>
  <dynamics damping="0.2" friction="0.0"/>
</joint>

<link name="back_right_steer_link">
  <inertial><origin xyz="0 0 0"/><mass value="0.2"/>
    <inertia ixx="0.0004" ixy="0" ixz="0" iyy="0.0004" iyz="0" izz="0.0004"/></inertial>
  <visual><origin xyz="0 0 0"/><geometry><box size="0.03 0.03 0.03"/></geometry></visual>
  <collision><origin xyz="0 0 0"/><geometry><box size="0.03 0.03 0.03"/></geometry></collision>
</link>

<joint type="continuous" name="back_right_wheel_joint">
  <origin xyz="0 0 0" rpy="0 0 0"/>
  <parent link="back_right_steer_link"/>
  <child link="back_right_wheel_link"/>
  <axis xyz="0 1 0"/>
  <limit effort="1000" velocity="1000"/>
  <dynamics damping="0.7" friction="1.0"/>
</joint>

<link name="back_right_wheel_link">
  <visual>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><mesh filename="$(find custom_robot_sim)/meshes/wheel_mesh.stl"/></geometry>
  </visual>
  <collision>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><cylinder length="0.1" radius="0.1"/></geometry>
  </collision>
  <xacro:inertial_cylinder radius="0.1" length="0.1" density="${density_pla}">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:inertial_cylinder>
</link>

<gazebo reference="back_right_wheel_link">
  <material>Gazebo/Grey</material>
</gazebo>

<!-- BACK LEFT: steer + passiv hjulrotasjon -->
<joint type="revolute" name="back_left_steer_joint">
  <origin xyz="-0.200 0.255 -0.050" rpy="0 0 0"/>
  <parent link="mobile_base_link"/>
  <child link="back_left_steer_link"/>
  <axis xyz="0 0 1"/>
  <limit lower="-0.7854" upper="0.7854" effort="200" velocity="1.5"/>
  <dynamics damping="0.2" friction="0.0"/>
</joint>

<link name="back_left_steer_link">
  <inertial><origin xyz="0 0 0"/><mass value="0.2"/>
    <inertia ixx="0.0004" ixy="0" ixz="0" iyy="0.0004" iyz="0" izz="0.0004"/></inertial>
  <visual><origin xyz="0 0 0"/><geometry><box size="0.03 0.03 0.03"/></geometry></visual>
  <collision><origin xyz="0 0 0"/><geometry><box size="0.03 0.03 0.03"/></geometry></collision>
</link>

<joint type="continuous" name="back_left_wheel_joint">
  <origin xyz="0 0 0" rpy="0 0 0"/>
  <parent link="back_left_steer_link"/>
  <child link="back_left_wheel_link"/>
  <axis xyz="0 1 0"/>
  <limit effort="1000" velocity="1000"/>
  <dynamics damping="0.7" friction="1.0"/>
</joint>

<link name="back_left_wheel_link">
  <visual>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><mesh filename="$(find custom_robot_sim)/meshes/wheel_mesh.stl"/></geometry>
  </visual>
  <collision>
    <origin xyz="0 0 0" rpy="1.57079632679 0 0"/>
    <geometry><cylinder length="0.1" radius="0.1"/></geometry>
  </collision>
  <xacro:inertial_cylinder radius="0.1" length="0.1" density="${density_pla}">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:inertial_cylinder>
</link>

<gazebo reference="back_left_wheel_link">
  <material>Gazebo/Grey</material>
</gazebo>



    <!--############################### -->
    <!-- ROBOTIC ARM -->
    <!--############################### -->

    <!-- ARM BASE -->
    <!-- ==================================== -->
    <joint type="fixed" name="arm_mount_fixed">
        <origin xyz="-0.15 0.0 0.0" rpy="0 0 0"/>
        <parent link="mobile_base_link"/>
        <child link="arm_base_link"/>
    </joint>

    <link name="arm_base_link">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <mesh filename="$(find custom_robot_sim)/meshes/arm_base_mesh.stl" />
            </geometry>
        </visual>
        <collision>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <geometry>
                <cylinder length="0.1" radius="${0.135/2}" />
            </geometry>
        </collision>
        <collision>
            <origin xyz="0 0 0.15" rpy="0 0 0"/>
            <geometry>
                <box size="0.075 0.075 0.1"/>
            </geometry>
        </collision>
        <xacro:inertial_cylinder radius="${0.135/2}" length="0.2" density="${density_pla}">
            <origin xyz="0 0 0.1" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <gazebo reference="arm_base_link">
        <material>Gazebo/DarkGrey</material>
    </gazebo>
    

    <!-- LINK 1 -->
    <!-- ==================================== -->
    <joint type="revolute" name="link_1_joint">
        <origin xyz="0 0 0.2" rpy="-${pi/2} 0 0"/>
        <child link="link_1_link"/>
        <parent link="arm_base_link"/>
        <axis xyz="0 0 1" rpy="0 0 0"/>
        <limit effort="100" velocity="100" lower="-${120*pi/180}" upper="${25*pi/180}"/>
        <dynamics damping="0.7" friction="1.0"/>
    </joint>

    <link name="link_1_link">
    <!-- orientert langs -y, midtpunkt på L1/2 -->
        <visual>
            <origin xyz="0 -${L1/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L1}" radius="${R}"/></geometry>
        </visual>
        <collision>
            <origin xyz="0 -${L1/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L1}" radius="${R}"/></geometry>
        </collision>
        <xacro:inertial_cylinder radius="${R}" length="${L1}" density="${density_pla}">
            <origin xyz="0 -${L1/2} 0" rpy="${pi/2} 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <gazebo reference="link_1_link">
        <material>Gazebo/DarkGrey</material>
    </gazebo>

    <!-- LINK 2 -->
    <!-- ==================================== -->
    <!-- JOINT 2 (albue, offset litt bakover) -->
    <joint type="revolute" name="link_2_joint">
        <origin xyz="0 -${L1} ${R*2}" rpy="0 0 0"/>
        <child link="link_2_link"/>
        <parent link="link_1_link"/>
        <axis xyz="0 0 1"/>
        <limit effort="100" velocity="100" lower="${0}" upper="${160*pi/180}"/>
        <dynamics damping="0.7" friction="1.0"/>
    </joint>

    <link name="link_2_link">
        <visual>
            <origin xyz="0 0 -0.0375" rpy="0 0 ${pi/2}"/>
            <geometry>
                <cylinder radius="0.035" length="0.15"/>
            </geometry>
        </visual>

        <visual>
            <origin xyz="0 -${L2/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L2}" radius="${R}"/></geometry>
        </visual>
        <collision>
            <origin xyz="0 -${L2/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L2}" radius="${R}"/></geometry>
        </collision>
        <xacro:inertial_cylinder radius="${R}" length="${L2}" density="${density_pla}">
            <origin xyz="0 -${L2/2} 0" rpy="${pi/2} 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <gazebo reference="link_2_link">
        <material>Gazebo/DarkGrey</material>
    </gazebo>

    <!-- LINK 3 -->
    <!-- ==================================== -->
    <!-- JOINT 3 (håndledd, offset tilbake litt) -->
    <joint name="link_3_joint" type="revolute">
        <parent link="link_2_link"/>
        <child link="link_3_link"/>
        <origin xyz="0 -${L2} -${R*2}" rpy="0 0 0"/> <!-- motsatt offset -->
        <axis xyz="0 0 1"/>
        <limit effort="100" velocity="100" lower="-${pi/2}" upper="${pi/2}"/>
        <dynamics damping="0.7" friction="1.0"/>
    </joint>

    <link name="link_3_link">
        <visual>
            <origin xyz="0 0 0.0375" rpy="0 0 ${pi/2}"/>
            <geometry>
                <cylinder radius="0.035" length="0.15"/>
            </geometry>
        </visual>

        <visual>
            <origin xyz="0 -${L3/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L3}" radius="${R}"/></geometry>
        </visual>
        <collision>
            <origin xyz="0 -${L3/2} 0" rpy="${pi/2} 0 0"/>
            <geometry><cylinder length="${L3}" radius="${R}"/></geometry>
        </collision>
        <xacro:inertial_cylinder radius="${R}" length="${L3}" density="${density_pla}">
            <origin xyz="0 -${L3/2} 0" rpy="${pi/2} 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <gazebo reference="link_3_link">
        <material>Gazebo/DarkGrey</material>
    </gazebo>

    <!-- === ENDEFFEKTOR MED SLIDER === -->
    <!-- Prismatisk joint -->
    <joint type="prismatic" name="ee_slider_joint">
        <origin xyz="0 -${L3} 0" rpy="0 0 0"/> <!-- Plassert i enden av link_3 -->
        <parent link="link_3_link"/>
        <child  link="ee_slider_link"/>
        <axis xyz="0 0 1"/>  <!-- bevegelse i X-retning -->
        <limit lower="-0.10" upper="0.10" effort="200" velocity="0.3"/>
        <dynamics damping="2.5" friction="0.2"/>
    </joint>

    <link name="ee_slider_link">
    <!-- Slider-kloss -->
    <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry><box size="0.04 0.02 0.2"/></geometry>
    </visual>
    <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry><box size="0.06 0.06 0.02"/></geometry>
    </collision>
    <inertial>
        <mass value="0.15"/>
        <inertia ixx="0.001" iyy="0.001" izz="0.001" ixy="0" ixz="0" iyz="0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
    </inertial>
    </link>

    <!-- Fastmontert verktøy på enden av slideren -->
    <joint type="fixed" name="tool_fixed_joint">
    <origin xyz="0.08 0 0" rpy="0 0 0"/> <!-- 8 cm fram i X-retning -->
    <parent link="ee_slider_link"/>
    <child  link="tool_link"/>
    </joint>

    <link name="tool_link">
    <!-- Bakplate -->
    <visual>
        <origin xyz="-0.14 -0.02 0" rpy="0 0 0"/>
        <geometry><box size="0.2 0.02 0.25"/></geometry>
    </visual>

    <!-- Gaffel -->
    <visual>
        <origin xyz="-0.05 -0.12 0.06" rpy="0 0 0"/>
        <geometry><box size="0.01 0.2 0.02"/></geometry>
    </visual>
    <visual>
        <origin xyz="-0.05 -0.12 -0.06" rpy="0 0 0"/>
        <geometry><box size="0.01 0.2 0.02"/></geometry>
    </visual>

    <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry><box size="0.04 0.04 0.04"/></geometry>
    </collision>
    <inertial>
        <mass value="0.1"/>
        <inertia ixx="0.0005" iyy="0.0005" izz="0.0005" ixy="0" ixz="0" iyz="0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
    </inertial>
    </link>

</robot>